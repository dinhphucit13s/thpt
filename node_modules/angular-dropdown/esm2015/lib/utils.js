/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,uselessCode} checked by tsc
 */
/**
 * @param {?} element
 * @param {?} callback
 * @return {?}
 */
export function waitForAnimation(element, callback) {
    if (element === null) {
        return;
    }
    requestAnimationFrame(() => {
        /** @type {?} */
        const computedStyle = window.getComputedStyle(element);
        if (computedStyle.animationName !== 'none' &&
            computedStyle.animationPlayState === 'running') {
            return once(element, 'animationend', callback);
        }
        callback();
    });
}
/**
 * @param {?} element
 * @param {?} eventName
 * @param {?} listener
 * @return {?}
 */
function once(element, eventName, listener) {
    element.addEventListener(eventName, function listenOnce(e) {
        element.removeEventListener(eventName, listenOnce);
        return listener(e);
    });
}
/** @type {?} */
export const closest = ((/** @type {?} */ (window))).Element && Element.prototype.closest
    ? (el, s) => el.closest(s)
    : function _closest(self, s) {
        /** @type {?} */
        const matches = (((/** @type {?} */ (self))).document || self.ownerDocument).querySelectorAll(s);
        /** @type {?} */
        let i;
        /** @type {?} */
        let el = self;
        do {
            i = matches.length;
            while (--i >= 0 && matches.item(i) !== el) { }
        } while (i < 0 && (el = el.parentElement));
        return el;
    };
/**
 * @param {?} trigger
 * @param {?} dropdown
 * @param {?} __2
 * @return {?}
 */
export function calculatePosition(trigger, dropdown, { horizontalPosition, verticalPosition, matchTriggerWidth, previousHorizontalPosition, previousVerticalPosition }) {
    // Collect information about all the involved DOM elements
    /** @type {?} */
    const scroll = { left: window.pageXOffset, top: window.pageYOffset };
    const { left: triggerLeft, top: triggerTop, width: triggerWidth, height: triggerHeight } = trigger.getBoundingClientRect();
    let { height: dropdownHeight, width: dropdownWidth } = dropdown.getBoundingClientRect();
    /** @type {?} */
    const viewportWidth = window.innerWidth;
    /** @type {?} */
    const style = {};
    // Calculate drop down width
    dropdownWidth = matchTriggerWidth ? triggerWidth : dropdownWidth;
    if (matchTriggerWidth) {
        style.width = dropdownWidth;
    }
    // Calculate horizontal position
    /** @type {?} */
    const triggerLeftWithScroll = triggerLeft + scroll.left;
    if (horizontalPosition === 'auto') {
        // Calculate the number of visible horizontal pixels if we were to place the
        // dropdown on the left and right
        /** @type {?} */
        const leftVisible = Math.min(viewportWidth, triggerLeft + dropdownWidth) -
            Math.max(0, triggerLeft);
        /** @type {?} */
        const rightVisible = Math.min(viewportWidth, triggerLeft + triggerWidth) -
            Math.max(0, triggerLeft + triggerWidth - dropdownWidth);
        if (dropdownWidth > leftVisible && rightVisible > leftVisible) {
            // If the drop down won't fit left-aligned, and there is more space on the
            // right than on the left, then force right-aligned
            horizontalPosition = 'right';
        }
        else if (dropdownWidth > rightVisible && leftVisible > rightVisible) {
            // If the drop down won't fit right-aligned, and there is more space on
            // the left than on the right, then force left-aligned
            horizontalPosition = 'left';
        }
        else {
            // Keep same position as previous
            horizontalPosition = previousHorizontalPosition || 'left';
        }
    }
    if (horizontalPosition === 'right') {
        style.right = viewportWidth - (triggerLeftWithScroll + triggerWidth);
    }
    else if (horizontalPosition === 'center') {
        style.left = triggerLeftWithScroll + (triggerWidth - dropdownWidth) / 2;
    }
    else {
        style.left = triggerLeftWithScroll;
    }
    // Calculate vertical position
    /** @type {?} */
    const triggerTopWithScroll = triggerTop + scroll.top;
    if (verticalPosition === 'above') {
        style.top = triggerTopWithScroll - dropdownHeight;
    }
    else if (verticalPosition === 'below') {
        style.top = triggerTopWithScroll + triggerHeight;
    }
    else {
        /** @type {?} */
        const viewportBottom = scroll.top + self.window.innerHeight;
        /** @type {?} */
        const enoughRoomBelow = triggerTopWithScroll + triggerHeight + dropdownHeight < viewportBottom;
        /** @type {?} */
        const enoughRoomAbove = triggerTop > dropdownHeight;
        if (previousVerticalPosition === 'below' &&
            !enoughRoomBelow &&
            enoughRoomAbove) {
            verticalPosition = 'above';
        }
        else if (previousVerticalPosition === 'above' &&
            !enoughRoomAbove &&
            enoughRoomBelow) {
            verticalPosition = 'below';
        }
        else if (!previousVerticalPosition) {
            verticalPosition = enoughRoomBelow ? 'below' : 'above';
        }
        else {
            verticalPosition = previousVerticalPosition;
        }
        style.top =
            triggerTopWithScroll +
                (verticalPosition === 'below' ? triggerHeight : -dropdownHeight);
    }
    return { horizontalPosition, verticalPosition, style };
}
/**
 * @param {?} trigger
 * @param {?} dropdown
 * @param {?} __2
 * @return {?}
 */
export function calculateInPlacePosition(trigger, dropdown, { horizontalPosition, verticalPosition }) {
    /** @type {?} */
    let dropdownRect;
    /** @type {?} */
    const positionData = {};
    if (horizontalPosition === 'auto') {
        /** @type {?} */
        const triggerRect = trigger.getBoundingClientRect();
        dropdownRect = dropdown.getBoundingClientRect();
        /** @type {?} */
        const viewportRight = window.pageXOffset + window.innerWidth;
        positionData.horizontalPosition =
            triggerRect.left + dropdownRect.width > viewportRight ? 'right' : 'left';
    }
    if (verticalPosition === 'above') {
        positionData.verticalPosition = verticalPosition;
        dropdownRect = dropdownRect || dropdown.getBoundingClientRect();
        positionData.style = { top: -dropdownRect.height };
    }
    return positionData;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXRpbHMuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9hbmd1bGFyLWRyb3Bkb3duLyIsInNvdXJjZXMiOlsibGliL3V0aWxzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7OztBQUFBLE1BQU0sMkJBQ0osT0FBdUIsRUFDdkIsUUFBNEI7SUFFNUIsSUFBSSxPQUFPLEtBQUssSUFBSSxFQUFFO1FBQ3BCLE9BQU87S0FDUjtJQUVELHFCQUFxQixDQUFDLEdBQUcsRUFBRTs7Y0FDbkIsYUFBYSxHQUFHLE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQyxPQUFPLENBQUM7UUFFdEQsSUFDRSxhQUFhLENBQUMsYUFBYSxLQUFLLE1BQU07WUFDdEMsYUFBYSxDQUFDLGtCQUFrQixLQUFLLFNBQVMsRUFDOUM7WUFDQSxPQUFPLElBQUksQ0FBQyxPQUFPLEVBQUUsY0FBYyxFQUFFLFFBQVEsQ0FBQyxDQUFDO1NBQ2hEO1FBRUQsUUFBUSxFQUFFLENBQUM7SUFDYixDQUFDLENBQUMsQ0FBQztBQUNMLENBQUM7Ozs7Ozs7QUFFRCxjQUNFLE9BQWEsRUFDYixTQUFpQixFQUNqQixRQUEyQjtJQUUzQixPQUFPLENBQUMsZ0JBQWdCLENBQUMsU0FBUyxFQUFFLG9CQUFvQixDQUFDO1FBQ3ZELE9BQU8sQ0FBQyxtQkFBbUIsQ0FBQyxTQUFTLEVBQUUsVUFBVSxDQUFDLENBQUM7UUFFbkQsT0FBTyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDckIsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDOztBQUVELE1BQU0sT0FBTyxPQUFPLEdBQ2xCLENBQUMsbUJBQUEsTUFBTSxFQUFPLENBQUMsQ0FBQyxPQUFPLElBQUksT0FBTyxDQUFDLFNBQVMsQ0FBQyxPQUFPO0lBQ2xELENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDLEVBQUUsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDO0lBQzFCLENBQUMsQ0FBQyxrQkFBa0IsSUFBYSxFQUFFLENBQVM7O2NB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RUFBRSxnQkFBZ0IsRUFBRSxLQUFLLEVBQUUsQ0FBQztBQUN6RCxDQUFDOzs7Ozs7O0FBRUQsTUFBTSxtQ0FDSixPQUFnQixFQUNoQixRQUFpQixFQUNqQixFQUFFLGtCQUFrQixFQUFFLGdCQUFnQixFQUFPOztRQUV6QyxZQUFZOztVQUNWLFlBQVksR0FBUSxFQUFFO0lBRTVCLElBQUksa0JBQWtCLEtBQUssTUFBTSxFQUFFOztjQUMzQixXQUFXLEdBQUcsT0FBTyxDQUFDLHFCQUFxQixFQUFFO1FBQ25ELFlBQVksR0FBRyxRQUFRLENBQUMscUJBQXFCLEVBQUUsQ0FBQzs7Y0FDMUMsYUFBYSxHQUFHLE1BQU0sQ0FBQyxXQUFXLEdBQUcsTUFBTSxDQUFDLFVBQVU7UUFDNUQsWUFBWSxDQUFDLGtCQUFrQjtZQUM3QixXQUFXLENBQUMsSUFBSSxHQUFHLFlBQVksQ0FBQyxLQUFLLEdBQUcsYUFBYSxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQztLQUM1RTtJQUNELElBQUksZ0JBQWdCLEtBQUssT0FBTyxFQUFFO1FBQ2hDLFlBQVksQ0FBQyxnQkFBZ0IsR0FBRyxnQkFBZ0IsQ0FBQztRQUNqRCxZQUFZLEdBQUcsWUFBWSxJQUFJLFFBQVEsQ0FBQyxxQkFBcUIsRUFBRSxDQUFDO1FBQ2hFLFlBQVksQ0FBQyxLQUFLLEdBQUcsRUFBRSxHQUFHLEVBQUUsQ0FBQyxZQUFZLENBQUMsTUFBTSxFQUFFLENBQUM7S0FDcEQ7SUFDRCxPQUFPLFlBQVksQ0FBQztBQUN0QixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiZXhwb3J0IGZ1bmN0aW9uIHdhaXRGb3JBbmltYXRpb24oXG4gIGVsZW1lbnQ6IEVsZW1lbnQgfCBudWxsLFxuICBjYWxsYmFjazogKGU/OiBFdmVudCkgPT4gYW55XG4pOiB2b2lkIHtcbiAgaWYgKGVsZW1lbnQgPT09IG51bGwpIHtcbiAgICByZXR1cm47XG4gIH1cblxuICByZXF1ZXN0QW5pbWF0aW9uRnJhbWUoKCkgPT4ge1xuICAgIGNvbnN0IGNvbXB1dGVkU3R5bGUgPSB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZShlbGVtZW50KTtcblxuICAgIGlmIChcbiAgICAgIGNvbXB1dGVkU3R5bGUuYW5pbWF0aW9uTmFtZSAhPT0gJ25vbmUnICYmXG4gICAgICBjb21wdXRlZFN0eWxlLmFuaW1hdGlvblBsYXlTdGF0ZSA9PT0gJ3J1bm5pbmcnXG4gICAgKSB7XG4gICAgICByZXR1cm4gb25jZShlbGVtZW50LCAnYW5pbWF0aW9uZW5kJywgY2FsbGJhY2spO1xuICAgIH1cblxuICAgIGNhbGxiYWNrKCk7XG4gIH0pO1xufVxuXG5mdW5jdGlvbiBvbmNlKFxuICBlbGVtZW50OiBOb2RlLFxuICBldmVudE5hbWU6IHN0cmluZyxcbiAgbGlzdGVuZXI6IChlOiBFdmVudCkgPT4gYW55XG4pOiB2b2lkIHtcbiAgZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKGV2ZW50TmFtZSwgZnVuY3Rpb24gbGlzdGVuT25jZShlKSB7XG4gICAgZWxlbWVudC5yZW1vdmVFdmVudExpc3RlbmVyKGV2ZW50TmFtZSwgbGlzdGVuT25jZSk7XG5cbiAgICByZXR1cm4gbGlzdGVuZXIoZSk7XG4gIH0pO1xufVxuXG5leHBvcnQgY29uc3QgY2xvc2VzdDogKGVsZW1lbnQ6IEVsZW1lbnQsIHNlbGVjdG9yOiBzdHJpbmcpID0+IEVsZW1lbnQgfCBudWxsID1cbiAgKHdpbmRvdyBhcyBhbnkpLkVsZW1lbnQgJiYgRWxlbWVudC5wcm90b3R5cGUuY2xvc2VzdFxuICAgID8gKGVsLCBzKSA9PiBlbC5jbG9zZXN0KHMpXG4gICAgOiBmdW5jdGlvbiBfY2xvc2VzdChzZWxmOiBFbGVtZW50LCBzOiBzdHJpbmcpIHtcbiAgICAgICAgY29uc3QgbWF0Y2hlcyA9IChcbiAgICAgICAgICAoc2VsZiBhcyBhbnkpLmRvY3VtZW50IHx8IHNlbGYub3duZXJEb2N1bWVudFxuICAgICAgICApLnF1ZXJ5U2VsZWN0b3JBbGwocyk7XG4gICAgICAgIGxldCBpO1xuICAgICAgICBsZXQgZWw6IEVsZW1lbnQgfCBudWxsID0gc2VsZjtcbiAgICAgICAgZG8ge1xuICAgICAgICAgIGkgPSBtYXRjaGVzLmxlbmd0aDtcbiAgICAgICAgICB3aGlsZSAoLS1pID49IDAgJiYgbWF0Y2hlcy5pdGVtKGkpICE9PSBlbCkge31cbiAgICAgICAgfSB3aGlsZSAoaSA8IDAgJiYgKGVsID0gZWwucGFyZW50RWxlbWVudCkpO1xuICAgICAgICByZXR1cm4gZWw7XG4gICAgICB9O1xuXG5leHBvcnQgZnVuY3Rpb24gY2FsY3VsYXRlUG9zaXRpb24oXG4gIHRyaWdnZXI6IEVsZW1lbnQsXG4gIGRyb3Bkb3duOiBFbGVtZW50LFxuICB7XG4gICAgaG9yaXpvbnRhbFBvc2l0aW9uLFxuICAgIHZlcnRpY2FsUG9zaXRpb24sXG4gICAgbWF0Y2hUcmlnZ2VyV2lkdGgsXG4gICAgcHJldmlvdXNIb3Jpem9udGFsUG9zaXRpb24sXG4gICAgcHJldmlvdXNWZXJ0aWNhbFBvc2l0aW9uXG4gIH06IGFueVxuKTogYW55IHtcbiAgLy8gQ29sbGVjdCBpbmZvcm1hdGlvbiBhYm91dCBhbGwgdGhlIGludm9sdmVkIERPTSBlbGVtZW50c1xuICBjb25zdCBzY3JvbGwgPSB7IGxlZnQ6IHdpbmRvdy5wYWdlWE9mZnNldCwgdG9wOiB3aW5kb3cucGFnZVlPZmZzZXQgfTtcbiAgY29uc3Qge1xuICAgIGxlZnQ6IHRyaWdnZXJMZWZ0LFxuICAgIHRvcDogdHJpZ2dlclRvcCxcbiAgICB3aWR0aDogdHJpZ2dlcldpZHRoLFxuICAgIGhlaWdodDogdHJpZ2dlckhlaWdodFxuICB9ID0gdHJpZ2dlci5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTtcbiAgbGV0IHtcbiAgICBoZWlnaHQ6IGRyb3Bkb3duSGVpZ2h0LFxuICAgIHdpZHRoOiBkcm9wZG93bldpZHRoXG4gIH0gPSBkcm9wZG93bi5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTtcbiAgY29uc3Qgdmlld3BvcnRXaWR0aCA9IHdpbmRvdy5pbm5lcldpZHRoO1xuICBjb25zdCBzdHlsZTogYW55ID0ge307XG5cbiAgLy8gQ2FsY3VsYXRlIGRyb3AgZG93biB3aWR0aFxuICBkcm9wZG93bldpZHRoID0gbWF0Y2hUcmlnZ2VyV2lkdGggPyB0cmlnZ2VyV2lkdGggOiBkcm9wZG93bldpZHRoO1xuICBpZiAobWF0Y2hUcmlnZ2VyV2lkdGgpIHtcbiAgICBzdHlsZS53aWR0aCA9IGRyb3Bkb3duV2lkdGg7XG4gIH1cblxuICAvLyBDYWxjdWxhdGUgaG9yaXpvbnRhbCBwb3NpdGlvblxuICBjb25zdCB0cmlnZ2VyTGVmdFdpdGhTY3JvbGwgPSB0cmlnZ2VyTGVmdCArIHNjcm9sbC5sZWZ0O1xuICBpZiAoaG9yaXpvbnRhbFBvc2l0aW9uID09PSAnYXV0bycpIHtcbiAgICAvLyBDYWxjdWxhdGUgdGhlIG51bWJlciBvZiB2aXNpYmxlIGhvcml6b250YWwgcGl4ZWxzIGlmIHdlIHdlcmUgdG8gcGxhY2UgdGhlXG4gICAgLy8gZHJvcGRvd24gb24gdGhlIGxlZnQgYW5kIHJpZ2h0XG4gICAgY29uc3QgbGVmdFZpc2libGUgPVxuICAgICAgTWF0aC5taW4odmlld3BvcnRXaWR0aCwgdHJpZ2dlckxlZnQgKyBkcm9wZG93bldpZHRoKSAtXG4gICAgICBNYXRoLm1heCgwLCB0cmlnZ2VyTGVmdCk7XG4gICAgY29uc3QgcmlnaHRWaXNpYmxlID1cbiAgICAgIE1hdGgubWluKHZpZXdwb3J0V2lkdGgsIHRyaWdnZXJMZWZ0ICsgdHJpZ2dlcldpZHRoKSAtXG4gICAgICBNYXRoLm1heCgwLCB0cmlnZ2VyTGVmdCArIHRyaWdnZXJXaWR0aCAtIGRyb3Bkb3duV2lkdGgpO1xuXG4gICAgaWYgKGRyb3Bkb3duV2lkdGggPiBsZWZ0VmlzaWJsZSAmJiByaWdodFZpc2libGUgPiBsZWZ0VmlzaWJsZSkge1xuICAgICAgLy8gSWYgdGhlIGRyb3AgZG93biB3b24ndCBmaXQgbGVmdC1hbGlnbmVkLCBhbmQgdGhlcmUgaXMgbW9yZSBzcGFjZSBvbiB0aGVcbiAgICAgIC8vIHJpZ2h0IHRoYW4gb24gdGhlIGxlZnQsIHRoZW4gZm9yY2UgcmlnaHQtYWxpZ25lZFxuICAgICAgaG9yaXpvbnRhbFBvc2l0aW9uID0gJ3JpZ2h0JztcbiAgICB9IGVsc2UgaWYgKGRyb3Bkb3duV2lkdGggPiByaWdodFZpc2libGUgJiYgbGVmdFZpc2libGUgPiByaWdodFZpc2libGUpIHtcbiAgICAgIC8vIElmIHRoZSBkcm9wIGRvd24gd29uJ3QgZml0IHJpZ2h0LWFsaWduZWQsIGFuZCB0aGVyZSBpcyBtb3JlIHNwYWNlIG9uXG4gICAgICAvLyB0aGUgbGVmdCB0aGFuIG9uIHRoZSByaWdodCwgdGhlbiBmb3JjZSBsZWZ0LWFsaWduZWRcbiAgICAgIGhvcml6b250YWxQb3NpdGlvbiA9ICdsZWZ0JztcbiAgICB9IGVsc2Uge1xuICAgICAgLy8gS2VlcCBzYW1lIHBvc2l0aW9uIGFzIHByZXZpb3VzXG4gICAgICBob3Jpem9udGFsUG9zaXRpb24gPSBwcmV2aW91c0hvcml6b250YWxQb3NpdGlvbiB8fCAnbGVmdCc7XG4gICAgfVxuICB9XG4gIGlmIChob3Jpem9udGFsUG9zaXRpb24gPT09ICdyaWdodCcpIHtcbiAgICBzdHlsZS5yaWdodCA9IHZpZXdwb3J0V2lkdGggLSAodHJpZ2dlckxlZnRXaXRoU2Nyb2xsICsgdHJpZ2dlcldpZHRoKTtcbiAgfSBlbHNlIGlmIChob3Jpem9udGFsUG9zaXRpb24gPT09ICdjZW50ZXInKSB7XG4gICAgc3R5bGUubGVmdCA9IHRyaWdnZXJMZWZ0V2l0aFNjcm9sbCArICh0cmlnZ2VyV2lkdGggLSBkcm9wZG93bldpZHRoKSAvIDI7XG4gIH0gZWxzZSB7XG4gICAgc3R5bGUubGVmdCA9IHRyaWdnZXJMZWZ0V2l0aFNjcm9sbDtcbiAgfVxuXG4gIC8vIENhbGN1bGF0ZSB2ZXJ0aWNhbCBwb3NpdGlvblxuICBjb25zdCB0cmlnZ2VyVG9wV2l0aFNjcm9sbCA9IHRyaWdnZXJUb3AgKyBzY3JvbGwudG9wO1xuICBpZiAodmVydGljYWxQb3NpdGlvbiA9PT0gJ2Fib3ZlJykge1xuICAgIHN0eWxlLnRvcCA9IHRyaWdnZXJUb3BXaXRoU2Nyb2xsIC0gZHJvcGRvd25IZWlnaHQ7XG4gIH0gZWxzZSBpZiAodmVydGljYWxQb3NpdGlvbiA9PT0gJ2JlbG93Jykge1xuICAgIHN0eWxlLnRvcCA9IHRyaWdnZXJUb3BXaXRoU2Nyb2xsICsgdHJpZ2dlckhlaWdodDtcbiAgfSBlbHNlIHtcbiAgICBjb25zdCB2aWV3cG9ydEJvdHRvbSA9IHNjcm9sbC50b3AgKyBzZWxmLndpbmRvdy5pbm5lckhlaWdodDtcbiAgICBjb25zdCBlbm91Z2hSb29tQmVsb3cgPVxuICAgICAgdHJpZ2dlclRvcFdpdGhTY3JvbGwgKyB0cmlnZ2VySGVpZ2h0ICsgZHJvcGRvd25IZWlnaHQgPCB2aWV3cG9ydEJvdHRvbTtcbiAgICBjb25zdCBlbm91Z2hSb29tQWJvdmUgPSB0cmlnZ2VyVG9wID4gZHJvcGRvd25IZWlnaHQ7XG5cbiAgICBpZiAoXG4gICAgICBwcmV2aW91c1ZlcnRpY2FsUG9zaXRpb24gPT09ICdiZWxvdycgJiZcbiAgICAgICFlbm91Z2hSb29tQmVsb3cgJiZcbiAgICAgIGVub3VnaFJvb21BYm92ZVxuICAgICkge1xuICAgICAgdmVydGljYWxQb3NpdGlvbiA9ICdhYm92ZSc7XG4gICAgfSBlbHNlIGlmIChcbiAgICAgIHByZXZpb3VzVmVydGljYWxQb3NpdGlvbiA9PT0gJ2Fib3ZlJyAmJlxuICAgICAgIWVub3VnaFJvb21BYm92ZSAmJlxuICAgICAgZW5vdWdoUm9vbUJlbG93XG4gICAgKSB7XG4gICAgICB2ZXJ0aWNhbFBvc2l0aW9uID0gJ2JlbG93JztcbiAgICB9IGVsc2UgaWYgKCFwcmV2aW91c1ZlcnRpY2FsUG9zaXRpb24pIHtcbiAgICAgIHZlcnRpY2FsUG9zaXRpb24gPSBlbm91Z2hSb29tQmVsb3cgPyAnYmVsb3cnIDogJ2Fib3ZlJztcbiAgICB9IGVsc2Uge1xuICAgICAgdmVydGljYWxQb3NpdGlvbiA9IHByZXZpb3VzVmVydGljYWxQb3NpdGlvbjtcbiAgICB9XG4gICAgc3R5bGUudG9wID1cbiAgICAgIHRyaWdnZXJUb3BXaXRoU2Nyb2xsICtcbiAgICAgICh2ZXJ0aWNhbFBvc2l0aW9uID09PSAnYmVsb3cnID8gdHJpZ2dlckhlaWdodCA6IC1kcm9wZG93bkhlaWdodCk7XG4gIH1cblxuICByZXR1cm4geyBob3Jpem9udGFsUG9zaXRpb24sIHZlcnRpY2FsUG9zaXRpb24sIHN0eWxlIH07XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBjYWxjdWxhdGVJblBsYWNlUG9zaXRpb24oXG4gIHRyaWdnZXI6IEVsZW1lbnQsXG4gIGRyb3Bkb3duOiBFbGVtZW50LFxuICB7IGhvcml6b250YWxQb3NpdGlvbiwgdmVydGljYWxQb3NpdGlvbiB9OiBhbnlcbikge1xuICBsZXQgZHJvcGRvd25SZWN0O1xuICBjb25zdCBwb3NpdGlvbkRhdGE6IGFueSA9IHt9O1xuXG4gIGlmIChob3Jpem9udGFsUG9zaXRpb24gPT09ICdhdXRvJykge1xuICAgIGNvbnN0IHRyaWdnZXJSZWN0ID0gdHJpZ2dlci5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTtcbiAgICBkcm9wZG93blJlY3QgPSBkcm9wZG93bi5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTtcbiAgICBjb25zdCB2aWV3cG9ydFJpZ2h0ID0gd2luZG93LnBhZ2VYT2Zmc2V0ICsgd2luZG93LmlubmVyV2lkdGg7XG4gICAgcG9zaXRpb25EYXRhLmhvcml6b250YWxQb3NpdGlvbiA9XG4gICAgICB0cmlnZ2VyUmVjdC5sZWZ0ICsgZHJvcGRvd25SZWN0LndpZHRoID4gdmlld3BvcnRSaWdodCA/ICdyaWdodCcgOiAnbGVmdCc7XG4gIH1cbiAgaWYgKHZlcnRpY2FsUG9zaXRpb24gPT09ICdhYm92ZScpIHtcbiAgICBwb3NpdGlvbkRhdGEudmVydGljYWxQb3NpdGlvbiA9IHZlcnRpY2FsUG9zaXRpb247XG4gICAgZHJvcGRvd25SZWN0ID0gZHJvcGRvd25SZWN0IHx8IGRyb3Bkb3duLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpO1xuICAgIHBvc2l0aW9uRGF0YS5zdHlsZSA9IHsgdG9wOiAtZHJvcGRvd25SZWN0LmhlaWdodCB9O1xuICB9XG4gIHJldHVybiBwb3NpdGlvbkRhdGE7XG59XG4iXX0=